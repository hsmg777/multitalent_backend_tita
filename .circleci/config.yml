version: 2.1

jobs:
  build-and-test:
    docker:
      - image: cimg/python:3.12
      - image: postgres:15
        environment:
          POSTGRES_DB: multitalent
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
    environment:
      DATABASE_URL: postgresql+psycopg2://user:password@localhost:5432/multitalent
      SQLALCHEMY_DATABASE_URI: postgresql+psycopg2://user:password@localhost:5432/multitalent
      COMPOSE_PROJECT: multitalent_backend
      COMPOSE_FILE: docker-compose.yml

    working_directory: ~/workspace

    steps:
      - checkout

      - run:
          name: üïê Esperar que PostgreSQL est√© disponible
          command: |
            for i in `seq 1 30`;
            do
              pg_isready -h localhost -U user && break
              echo "Esperando PostgreSQL..."
              sleep 2
            done

      - run:
          name: üì¶ Instalar dependencias
          command: |
            python -m pip install -U pip
            pip install -r requirements.txt

      - run:
          name: üß± Migrar y poblar base de datos
          command: |
            flask --app app.wsgi db upgrade
            flask --app app.wsgi seed-admin

      - run:
          name: üßπ Linter (flake8)
          command: |
            pip install flake8
            flake8 . --count --exit-zero --max-complexity=12 --max-line-length=100 --statistics

      - run:
          name: üîç Type Check (mypy)
          command: |
            pip install mypy types-requests types-psycopg2
            mypy app || true

      - run:
          name: üß† Security Scan (bandit)
          command: |
            pip install bandit
            bandit -r app -f xml -o bandit-report.xml || true

      - run:
          name: üß™ Tests (pytest + coverage)
          command: |
            pip install pytest pytest-cov
            pytest -v --maxfail=1 --junitxml=pytest-report.xml --cov=app --cov-report=xml:coverage.xml

      - store_artifacts:
          path: pytest-report.xml
          destination: reports/pytest
      - store_artifacts:
          path: coverage.xml
          destination: reports/coverage
      - store_artifacts:
          path: bandit-report.xml
          destination: reports/security

      # ‚úÖ Notificaci√≥n Telegram - √âxito
      - run:
          name: ‚úÖ Notificar √©xito en Telegram
          when: on_success
          command: |
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="‚úÖ *Build completado correctamente en CircleCI!*%0AProyecto: multitalent_backend_tita%0ARama: ${CIRCLE_BRANCH}%0AJob: ${CIRCLE_JOB}%0Aüîó [Ver detalles en CircleCI](${CIRCLE_BUILD_URL})" \
              -d parse_mode="Markdown"

      # ‚ùå Notificaci√≥n Telegram - Falla
      - run:
          name: ‚ùå Notificar fallo en Telegram
          when: on_fail
          command: |
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="‚ùå *Build fall√≥!*%0AProyecto: multitalent_backend_tita%0ARama: ${CIRCLE_BRANCH}%0AJob: ${CIRCLE_JOB}%0Aüîó [Ver errores en CircleCI](${CIRCLE_BUILD_URL})" \
              -d parse_mode="Markdown"

  deploy:
    machine: true
    steps:
      - checkout
      - run:
          name: üöÄ Deploy con Docker Compose
          command: |
            echo "Desplegando servicio..."
            docker compose pull
            docker compose down --remove-orphans
            docker compose up -d --build
            docker compose ps
            echo "‚úÖ Deploy completado correctamente."

      # üì≤ Notificaci√≥n de despliegue Telegram
      - run:
          name: üöÄ Notificar despliegue
          when: on_success
          command: |
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="üöÄ *Despliegue completado correctamente!*%0AProyecto: multitalent_backend_tita%0ARama: ${CIRCLE_BRANCH}%0Aüîó [Ver build en CircleCI](${CIRCLE_BUILD_URL})" \
              -d parse_mode="Markdown"

workflows:
  version: 2
  build_and_deploy:
    jobs:
      - build-and-test
      - deploy:
          requires:
            - build-and-test
          filters:
            branches:
              only:
                - develop
                - main
